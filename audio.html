<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <script>
        var my_div = document.createElement("DIV");
        var my_p = document.createElement("P");
        var my_btn = document.createElement("BUTTON");
        var t = document.createTextNode("Press to start recording");

        my_btn.appendChild(t);
        my_div.appendChild(my_btn);
        document.body.appendChild(my_div);

        var base64data = 0;
        var reader;
        var recorder, gumStream;
        var recordButton = my_btn;

        var handleSuccess = function (stream) {
            gumStream = stream;
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = function (e) {
                var url = URL.createObjectURL(e.data);
                reader = new FileReader();
                reader.readAsDataURL(e.data);
                reader.onloadend = function () {
                    base64data = reader.result;
                }
            };
            recorder.start()
        };

        recordButton.innerText = "Press to START";
        // navigator.mediaDevices.getUserMedia({ audio: true }).then(handleSuccess);

        function toggleRecording() {
            if (recorder && recorder.state == "recording") {
                recorder.stop();
                gumStream.getAudioTracks()[0].stop();
                recordButton.innerText = "Saving the recording... pease wait!"
            }
            else {
                recordButton.innerText = "Recording... press to stop";
                navigator.mediaDevices.getUserMedia({ audio: true }).then(handleSuccess);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        var data = new Promise(resolve => {
            //recordButton.addEventListener("click", toggleRecording);
            recordButton.onclick = () => {
                sleep(2000).then(() => {
                    // wait 2000ms for the data to be available...
                    // ideally this should use something like await...
                    console.log("Inside data:" + base64data)
                    resolve(base64data.toString())
                    toggleRecording()
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            console.log(this.responseText);
                        }
                    };
                    xhr.open("POST", "url-cim-a-code.hu-oldalon", true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    //xhr.send("audio_data=" + base64data);
                });

            }
        }).then(() => { //on success
            recordButton.innerText = "Press to START";
        }).catch(function (err) {
            console.log('Nem sikerült hozzáférni az eszközhöz: ' + err.message);
        });

    </script>
</body>

</html>